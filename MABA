import React, { useState, useRef } from 'react';
import { 
  Upload, 
  Image as ImageIcon, 
  Video, 
  Check, 
  Copy, 
  RefreshCcw, 
  Sparkles, 
  Instagram, 
  Facebook, 
  Linkedin, 
  BookOpen,
  Share2,
  Type,
  Download,
  ArrowRight,
  Layout,
  Palette,
  Maximize,
  Wand2, 
  Loader2,
  FileText,
  UserCircle2
} from 'lucide-react';

export default function PostAssistant() {
  const [step, setStep] = useState(1); // 1: Input, 2: Generating, 3: Result
  
  // ä¸»ç´ æ
  const [media, setMedia] = useState(null);
  const [mediaPreview, setMediaPreview] = useState(null);
  const [mediaType, setMediaType] = useState('image'); 
  
  // åƒè€ƒç´ æ (æ–°å¢)
  const [refMedia, setRefMedia] = useState(null);
  const [refMediaPreview, setRefMediaPreview] = useState(null);
  const [refText, setRefText] = useState('');

  // AI ç”Ÿæˆçš„æ–°åœ–
  const [aiCoverImage, setAiCoverImage] = useState(null); 

  const [platform, setPlatform] = useState('instagram');
  const [keywords, setKeywords] = useState('');
  const [cta, setCta] = useState('');
  
  // è¦–è¦ºé¢¨æ ¼æè¿°ç‹€æ…‹
  const [visualStyle, setVisualStyle] = useState('');

  // äººè¨­/å ´æ™¯ç‹€æ…‹ (ä¿®æ”¹)
  const [persona, setPersona] = useState('blogger'); 

  // å°é¢åœ–è¨­å®šç‹€æ…‹
  const [coverRatio, setCoverRatio] = useState('4/5'); 
  const [coverStyle, setCoverStyle] = useState('magazine'); 

  const [generatedResult, setGeneratedResult] = useState(null);
  const [isCopied, setIsCopied] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  const [loadingStatus, setLoadingStatus] = useState('');

  const fileInputRef = useRef(null);
  const refFileInputRef = useRef(null); // åƒè€ƒåœ–ç‰‡çš„ ref
  const apiKey = ""; // ä½¿ç”¨åŸ·è¡Œç’°å¢ƒæä¾›çš„ API Key

  const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64String = reader.result.split(',')[1];
        resolve(base64String);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setMedia(file);
      setMediaPreview(URL.createObjectURL(file));
      setMediaType(file.type.startsWith('video') ? 'video' : 'image');
      setAiCoverImage(null);
    }
  };

  // è™•ç†åƒè€ƒåœ–ç‰‡ä¸Šå‚³
  const handleRefFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setRefMedia(file);
      setRefMediaPreview(URL.createObjectURL(file));
    }
  };

  // å‘¼å« Gemini é€²è¡Œæ–‡å­—ç”Ÿæˆ (æ–‡æ¡ˆ + æ’ç‰ˆå»ºè­°)
  const generateTextAndLayout = async (base64MainImage, base64RefImage, selectedPersona) => {
    setLoadingStatus('æ­£åœ¨åˆ†æåƒè€ƒè³‡æ–™èˆ‡æ’°å¯«æ–‡æ¡ˆ...');
    
    let systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ç¤¾ç¾¤åª’é«”ç¶“ç‡Ÿå°ˆå®¶ã€‚
    è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„ã€Œä¸»è¦åœ–ç‰‡ã€ã€é—œéµå­—ã€ç™¼å¸ƒå¹³å°èˆ‡ã€Œäººè¨­(Persona)ã€ï¼Œç”Ÿæˆè²¼æ–‡å…§å®¹ã€‚
    
    ä½¿ç”¨è€…è¨­å®šï¼š
    - å¹³å°ï¼š${platform}
    - é—œéµå­—ï¼š${keywords}
    - ç™¼æ–‡äººè¨­/å ´æ™¯ï¼š${selectedPersona.name} (${selectedPersona.desc})
    - è¦–è¦ºè¨­è¨ˆéœ€æ±‚ï¼š${visualStyle || 'ç”± AI æ ¹æ“šåœ–ç‰‡åˆ¤æ–·'}
    - CTAï¼š${cta || 'ç”±ä½ æ±ºå®š'}
    
    ã€é‡è¦ï¼šåƒè€ƒè³‡æ–™ä½¿ç”¨è¦å‰‡ã€‘
    ä½¿ç”¨è€…å¯èƒ½æœƒæä¾›ã€Œåƒè€ƒåœ–ç‰‡ã€æˆ–ã€Œåƒè€ƒæ–‡æ¡ˆã€ã€‚
    1. è«‹åˆ†æåƒè€ƒè³‡æ–™çš„ã€Œèªæ°£çµæ§‹ã€ã€ã€Œæ’ç‰ˆé‚è¼¯ã€æˆ–ã€Œæ•˜äº‹é¢¨æ ¼ã€ã€‚
    2. å°‡é€™äº›é¢¨æ ¼æ‡‰ç”¨åœ¨æœ¬æ¬¡çš„å‰µä½œä¸­ã€‚
    3. çµ•å°**ä¸èƒ½**ç›´æ¥è¤‡è£½åƒè€ƒè³‡æ–™çš„å…§å®¹ï¼Œå¿…é ˆåŸºæ–¼ã€Œä¸»è¦åœ–ç‰‡ã€å’Œã€Œé—œéµå­—ã€é€²è¡ŒåŸå‰µã€‚
    4. å¦‚æœæœ‰åƒè€ƒæ–‡æ¡ˆï¼š${refText ? `åƒè€ƒæ–‡æ¡ˆå…§å®¹ç‚ºï¼š"${refText}"` : 'ç„¡'}ã€‚

    ç›®å‰ç³»çµ±æ”¯æ´ä»¥ä¸‹å››ç¨®å°é¢æ’ç‰ˆé¢¨æ ¼ (Layout Styles)ï¼š
    1. magazine (é›œèªŒé¢¨ï¼šé©åˆæ™‚å°šã€è±å¯Œè³‡è¨Šï¼Œæ–‡å­—åœ¨åº•éƒ¨)
    2. minimal (æ¥µç°¡ç™½ï¼šé©åˆæ–‡é’ã€ä¹¾æ·¨ï¼Œæ–‡å­—ç½®ä¸­)
    3. bold (å¤§æ¨™é¡Œï¼šé©åˆä¿ƒéŠ·ã€å¼·çƒˆè¦–è¦ºï¼Œé»ƒåº•é»‘å­—)
    4. cinematic (é›»å½±æ„Ÿï¼šé©åˆæ•˜äº‹ã€æ°›åœï¼Œä¸Šä¸‹é»‘é‚Š)

    è«‹å›å‚³ç´” JSON ç‰©ä»¶ï¼š
    {
      "caption": "è²¼æ–‡å…§æ–‡ (è«‹å®Œå…¨ç¬¦åˆé¸å®šçš„äººè¨­èªæ°£)",
      "hashtags": "hashtag",
      "coverTitle": "å°é¢æ¨™é¡Œ (2-6å­—)",
      "coverSubtitle": "å°é¢å‰¯æ¨™é¡Œ (10-15å­—)",
      "suggestedLayout": "magazine" æˆ– "minimal" æˆ– "bold" æˆ– "cinematic"
    }
    `;

    if (platform === 'blog') {
      systemPrompt += `\nç‰¹åˆ¥æ³¨æ„ï¼šç”Ÿæˆä¸€ç¯‡ Markdown æ ¼å¼çš„éƒ¨è½æ ¼é•·æ–‡ã€‚`;
    }

    // å»ºæ§‹ Multi-modal å…§å®¹
    const contentParts = [
      { text: systemPrompt },
      { text: "ã€ä¸»è¦åœ–ç‰‡ (åŸºæ–¼æ­¤åœ–å‰µä½œ)ã€‘ï¼š" },
      { inlineData: { mimeType: 'image/jpeg', data: base64MainImage } }
    ];

    if (base64RefImage) {
      contentParts.push({ text: "ã€åƒè€ƒåœ–ç‰‡ (åƒ…ä¾›é¢¨æ ¼åƒè€ƒï¼Œéå‰µä½œä¸»é«”)ã€‘ï¼š" });
      contentParts.push({ inlineData: { mimeType: 'image/jpeg', data: base64RefImage } });
    }

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: contentParts }],
        generationConfig: { responseMimeType: "application/json" }
      })
    });

    const data = await response.json();
    if (!data.candidates) throw new Error("Text API Error");
    return JSON.parse(data.candidates[0].content.parts[0].text);
  };

  // å‘¼å« Gemini é€²è¡Œå½±åƒé‡ç¹ª (Image Editing)
  const generateStyledImage = async (base64Image) => {
    if (!visualStyle) return null;
    
    setLoadingStatus(`æ­£åœ¨ä¾æ“šã€Œ${visualStyle}ã€ç¹ªè£½æ–°åœ–ç‰‡...`);
    
    const imagePrompt = `Modify this image to match the following style description strictly: ${visualStyle}. High quality, detailed, aesthetic social media cover.`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: imagePrompt },
              { inlineData: { mimeType: 'image/jpeg', data: base64Image } }
            ]
          }],
          generationConfig: { 
            responseModalities: ["IMAGE"] 
          }
        })
      });

      const data = await response.json();
      if (!data.candidates || !data.candidates[0].content.parts[0].inlineData) {
        return null;
      }
      return `data:image/jpeg;base64,${data.candidates[0].content.parts[0].inlineData.data}`;
    } catch (e) {
      console.error("Image Gen Error:", e);
      return null;
    }
  };

  const callGeminiAPI = async () => {
    if (!media) return;

    setStep(2);
    setErrorMsg('');
    setAiCoverImage(null);

    try {
      // 1. æº–å‚™åœ–ç‰‡è³‡æ–™
      const base64Main = await fileToBase64(media);
      const base64Ref = refMedia ? await fileToBase64(refMedia) : null;
      
      const selectedPersona = personas.find(p => p.id === persona) || personas[0];

      // 2. å¹³è¡ŒåŸ·è¡Œ
      const [textResult, imageResult] = await Promise.all([
        generateTextAndLayout(base64Main, base64Ref, selectedPersona),
        visualStyle ? generateStyledImage(base64Main) : Promise.resolve(null)
      ]);

      // 3. è™•ç†çµæœ
      setGeneratedResult(textResult);
      if (textResult.suggestedLayout && coverStyles[textResult.suggestedLayout]) {
        setCoverStyle(textResult.suggestedLayout);
      }

      if (imageResult) {
        setAiCoverImage(imageResult);
      }

      setStep(3);

    } catch (err) {
      console.error(err);
      setErrorMsg("AI è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      setStep(1);
    }
  };

  const resetApp = () => {
    setStep(1);
    setGeneratedResult(null);
    setIsCopied(false);
    setErrorMsg('');
    setVisualStyle('');
    setAiCoverImage(null);
    setRefMedia(null);
    setRefMediaPreview(null);
    setRefText('');
  };

  const handleCopy = () => {
    if (generatedResult) {
      navigator.clipboard.writeText(generatedResult.caption);
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    }
  };

  // ä¿®æ”¹ï¼šäººè¨­/å ´æ™¯é¸é …
  const personas = [
    { id: 'politician', name: 'æ”¿æ²»äººç‰©', emoji: 'ğŸ›ï¸', desc: 'ç©©é‡ã€æ„Ÿæ€§ã€ä½¿å‘½æ„Ÿã€è™Ÿå¬åŠ›' },
    { id: 'company', name: 'ä¼æ¥­/å“ç‰Œ', emoji: 'ğŸ¢', desc: 'å°ˆæ¥­ã€ä¿¡ä»»ã€åƒ¹å€¼ä¸»å¼µã€å®˜æ–¹å£å»' },
    { id: 'celebrity', name: 'è—äºº/ç¶²ç´…', emoji: 'âœ¨', desc: 'å¸ç›ã€å€‹äººé¢¨æ ¼å¼·çƒˆã€å¯µç²‰ã€æ´»æ½‘' },
    { id: 'blogger', name: 'éƒ¨è½å®¢/KOL', emoji: 'âœï¸', desc: 'ä¹¾è²¨åˆ†äº«ã€è¦ªåˆ‡é«”é©—ã€æ¢ç†åˆ†æ˜' },
    { id: 'friend', name: 'æœ‹å‹/æ—¥å¸¸', emoji: 'ğŸ¤', desc: 'è¼•é¬†ã€çœŸå¯¦ã€ç„¡è·é›¢æ„Ÿã€å£èªåŒ–' },
  ];

  const ratios = [
    { id: '1/1', name: 'æ­£æ–¹å½¢ (1:1)', class: 'aspect-square' },
    { id: '4/5', name: 'IG è²¼æ–‡ (4:5)', class: 'aspect-[4/5]' },
    { id: '16/9', name: 'æ©«å¼ (16:9)', class: 'aspect-video' },
    { id: '9/16', name: 'é™å‹• (9:16)', class: 'aspect-[9/16]' },
  ];

  const coverStyles = {
    magazine: {
      name: 'é›œèªŒé¢¨',
      overlayClass: 'bg-gradient-to-t from-black/80 via-transparent to-black/30',
      textContainerClass: 'bottom-12 left-6 right-6 text-left',
      titleClass: 'text-3xl font-bold font-serif leading-tight mb-3 drop-shadow-xl text-white',
      subtitleClass: 'text-sm text-white/80 font-light tracking-wide italic',
      deco: (platform) => (
        <div className="absolute top-6 left-6 right-6 border-t border-white/50 pt-2 flex justify-between items-center">
           <span className="text-[10px] tracking-[0.2em] uppercase text-white/90">{platform.toUpperCase()} ISSUE</span>
           <span className="text-[10px] text-white/90">VOL.01</span>
        </div>
      )
    },
    minimal: {
      name: 'æ¥µç°¡ç™½',
      overlayClass: 'bg-white/10 backdrop-blur-[2px] m-4 rounded-xl border border-white/20 shadow-2xl',
      textContainerClass: 'inset-0 flex flex-col items-center justify-center text-center p-6',
      titleClass: 'text-2xl font-bold tracking-wider text-white drop-shadow-md mb-4 uppercase',
      subtitleClass: 'text-xs text-white/90 bg-black/20 px-3 py-1 rounded-full backdrop-blur-md',
      deco: () => null
    },
    bold: {
      name: 'å¤§æ¨™é¡Œ',
      overlayClass: 'bg-black/40',
      textContainerClass: 'bottom-0 left-0 right-0 bg-yellow-400 p-6 text-black',
      titleClass: 'text-4xl font-black uppercase tracking-tighter leading-none mb-2 text-black',
      subtitleClass: 'text-sm font-bold text-black/70',
      deco: () => (
         <div className="absolute top-4 right-4 bg-black text-white font-bold px-3 py-1 text-sm -rotate-3">
           NEW!
         </div>
      )
    },
    cinematic: {
      name: 'é›»å½±æ„Ÿ',
      overlayClass: 'bg-gradient-to-b from-black/60 via-transparent to-black/80',
      textContainerClass: 'bottom-8 left-0 right-0 text-center',
      titleClass: 'text-xl font-light tracking-[0.5em] text-white mb-2 uppercase text-shadow-sm',
      subtitleClass: 'text-xs text-gray-300 font-serif italic',
      deco: () => (
        <>
          <div className="absolute top-0 left-0 right-0 h-[10%] bg-black"></div>
          <div className="absolute bottom-0 left-0 right-0 h-[10%] bg-black"></div>
        </>
      )
    }
  };

  const platforms = [
    { id: 'instagram', name: 'Instagram', icon: <Instagram size={18} />, color: 'bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 text-white' },
    { id: 'facebook', name: 'Facebook', icon: <Facebook size={18} />, color: 'bg-blue-600 text-white' },
    { id: 'linkedin', name: 'LinkedIn', icon: <Linkedin size={18} />, color: 'bg-blue-700 text-white' },
    { id: 'threads', name: 'Threads', icon: <span className="font-bold text-lg leading-none">@</span>, color: 'bg-black text-white' },
    { id: 'blog', name: 'éƒ¨è½æ ¼', icon: <BookOpen size={18} />, color: 'bg-emerald-600 text-white' },
  ];

  const currentStyle = coverStyles[coverStyle];

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
      <header className="bg-white border-b border-slate-200 sticky top-0 z-20">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2 cursor-pointer" onClick={resetApp}>
            <div className="bg-indigo-600 p-2 rounded-lg text-white">
              <Sparkles size={20} />
            </div>
            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
              PostGenie Pro
            </h1>
          </div>
          <div className="text-xs font-medium text-slate-500 border border-slate-200 px-2 py-1 rounded-full hidden sm:block">
            AI ç¤¾ç¾¤è²¼æ–‡åŠ©æ‰‹
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 py-8">
        {errorMsg && (
          <div className="fixed top-20 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50 animate-bounce">
            {errorMsg}
          </div>
        )}

        {step === 1 && (
          <div className="grid md:grid-cols-12 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Left: Upload & Platform (5 cols) */}
            <div className="md:col-span-5 space-y-6">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-700">
                  <div className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-xs flex items-center justify-center">1</div>
                  ä¸»ç´ æèˆ‡å¹³å°
                </h2>
                
                {/* Upload Area */}
                <div 
                  className={`group border-2 border-dashed rounded-xl h-56 flex flex-col items-center justify-center cursor-pointer transition-all mb-6 relative overflow-hidden ${mediaPreview ? 'border-indigo-300' : 'border-slate-300 hover:border-indigo-400 hover:bg-slate-50'}`}
                  onClick={() => fileInputRef.current.click()}
                >
                  <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                  
                  {mediaPreview ? (
                    <>
                      <img src={mediaPreview} alt="Preview" className="w-full h-full object-cover" />
                      <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                         <span className="text-white text-sm font-medium flex items-center gap-1 bg-black/50 px-3 py-1 rounded-full backdrop-blur-sm">
                           <RefreshCcw size={14} /> æ›´æ›åœ–ç‰‡
                         </span>
                      </div>
                    </>
                  ) : (
                    <div className="text-center p-6">
                      <div className="w-14 h-14 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                        <Upload size={24} />
                      </div>
                      <p className="text-slate-600 font-medium text-sm">é»æ“Šä¸Šå‚³ä¸»åœ–ç‰‡</p>
                      <p className="text-slate-400 text-xs mt-1">æ”¯æ´ JPG, PNG</p>
                    </div>
                  )}
                </div>

                {/* Platform Selector */}
                <div className="space-y-2">
                  <label className="text-sm font-medium text-slate-700">é¸æ“‡ç™¼å¸ƒå¹³å°</label>
                  <div className="grid grid-cols-3 gap-2">
                    {platforms.map((p) => (
                      <button
                        key={p.id}
                        onClick={() => setPlatform(p.id)}
                        className={`flex items-center gap-2 p-2 rounded-lg border transition-all ${platform === p.id ? 'border-indigo-600 bg-indigo-50 text-indigo-900 ring-1 ring-indigo-200' : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                      >
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center ${p.color} scale-75`}>
                          {p.icon}
                        </div>
                        <span className="text-xs font-medium">{p.name}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>

               {/* Reference Section (New) */}
               <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-700">
                  <div className="w-6 h-6 rounded-full bg-orange-100 text-orange-600 text-xs flex items-center justify-center">?</div>
                  åƒè€ƒè³‡æ–™ (AI æ¨¡ä»¿ç”¨)
                </h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs font-medium text-slate-500 mb-2">åƒè€ƒåœ–ç‰‡ (é¢¨æ ¼/æ’ç‰ˆ)</label>
                    <div 
                      className={`border border-dashed rounded-lg h-24 flex items-center justify-center cursor-pointer transition-all ${refMediaPreview ? 'border-orange-300' : 'border-slate-200 hover:bg-slate-50'}`}
                      onClick={() => refFileInputRef.current.click()}
                    >
                      <input type="file" ref={refFileInputRef} className="hidden" accept="image/*" onChange={handleRefFileChange} />
                      {refMediaPreview ? (
                         <div className="relative w-full h-full p-1">
                           <img src={refMediaPreview} alt="Ref" className="w-full h-full object-contain rounded" />
                           <button className="absolute top-1 right-1 bg-white p-1 rounded-full shadow-sm" onClick={(e) => { e.stopPropagation(); setRefMedia(null); setRefMediaPreview(null); }}>
                             <RefreshCcw size={10} />
                           </button>
                         </div>
                      ) : (
                        <div className="text-center text-slate-400 text-xs flex flex-col items-center gap-1">
                          <ImageIcon size={16} />
                          <span>ä¸Šå‚³ç¯„ä¾‹åœ–ç‰‡</span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-xs font-medium text-slate-500 mb-2">åƒè€ƒæ–‡æ¡ˆ (èªæ°£/çµæ§‹)</label>
                    <textarea 
                      className="w-full p-3 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none resize-none h-20"
                      placeholder="è²¼ä¸Šæ‚¨å–œæ­¡çš„æ–‡æ¡ˆç¯„æœ¬ï¼ŒAI æœƒå­¸ç¿’å®ƒçš„èªæ°£..."
                      value={refText}
                      onChange={(e) => setRefText(e.target.value)}
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Right: Details & Persona (7 cols) */}
            <div className="md:col-span-7 space-y-6">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full flex flex-col">
                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-700">
                  <div className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 text-xs flex items-center justify-center">2</div>
                  å…§å®¹è¨­å®šèˆ‡äººè¨­
                </h2>

                <div className="space-y-5 flex-1">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1.5">
                      è²¼æ–‡é—œéµå­— <span className="text-red-400">*</span>
                    </label>
                    <input
                      type="text"
                      className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none text-sm"
                      placeholder="ä¾‹å¦‚ï¼šéœ²ç‡Ÿ, å¯§éœ, æ£®æ—æµ´..."
                      value={keywords}
                      onChange={(e) => setKeywords(e.target.value)}
                    />
                  </div>

                  {/* Persona Selector (New) */}
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                      <UserCircle2 size={16} />
                      ç™¼æ–‡äººè¨­ / å ´æ™¯ (Persona)
                    </label>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                      {personas.map((p) => (
                        <button
                          key={p.id}
                          onClick={() => setPersona(p.id)}
                          className={`flex items-start gap-3 p-3 rounded-xl border text-left transition-all ${persona === p.id ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-200' : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'}`}
                        >
                          <span className="text-2xl pt-0.5">{p.emoji}</span>
                          <div>
                            <div className={`text-sm font-bold ${persona === p.id ? 'text-indigo-900' : 'text-slate-700'}`}>{p.name}</div>
                            <div className="text-[10px] text-slate-500 mt-0.5">{p.desc}</div>
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1.5 flex items-center gap-2">
                      è¦–è¦ºè¨­è¨ˆ/æ’ç‰ˆéœ€æ±‚
                      <span className="flex items-center gap-1 text-xs text-white bg-gradient-to-r from-indigo-500 to-purple-500 px-2 py-0.5 rounded-full">
                         <Wand2 size={10} /> AI ç¹ªåœ–
                      </span>
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none text-sm"
                        placeholder="ä¾‹å¦‚ï¼šå¾©å¤åº•ç‰‡æ„Ÿã€éœ“è™¹ç‡ˆè³½åšé¾å…‹ã€å®®å´é§¿å‹•æ¼«é¢¨..."
                        value={visualStyle}
                        onChange={(e) => setVisualStyle(e.target.value)}
                      />
                      <Palette size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                    </div>
                    <p className="text-xs text-slate-400 mt-1.5 ml-1">è‹¥å¡«å¯«æ­¤æ¬„ï¼ŒAI å°‡æœƒé‡æ–°ç¹ªè£½åº•åœ–ï¼Œè€Œä¸åƒ…åƒ…æ˜¯æ’ç‰ˆã€‚</p>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1.5">
                      è¡Œå‹•å‘¼ç±² (CTA) <span className="text-slate-400 font-normal text-xs ml-1">(é¸å¡«)</span>
                    </label>
                    <input
                      type="text"
                      className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none text-sm"
                      placeholder="ä¾‹å¦‚ï¼šé»æ“Šé€£çµã€ç•™è¨€ +1..."
                      value={cta}
                      onChange={(e) => setCta(e.target.value)}
                    />
                  </div>
                </div>

                <div className="mt-8 pt-6 border-t border-slate-100">
                  <button
                    onClick={callGeminiAPI}
                    disabled={!media || !keywords}
                    className={`w-full py-3.5 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all ${
                      media && keywords
                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-0.5' 
                        : 'bg-slate-100 text-slate-400 cursor-not-allowed'
                    }`}
                  >
                    <Sparkles size={18} />
                    {media ? (keywords ? 'AI ç«‹å³ç”Ÿæˆ' : 'è«‹è¼¸å…¥é—œéµå­—') : 'è«‹å…ˆä¸Šå‚³ç…§ç‰‡'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {step === 2 && (
          <div className="flex flex-col items-center justify-center min-h-[50vh] animate-in fade-in duration-700">
            <div className="relative">
              <div className="w-20 h-20 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
              <Sparkles className="absolute inset-0 m-auto text-indigo-600 animate-pulse" size={24} />
            </div>
            <h2 className="text-xl font-bold mt-6 text-slate-800">AI æ­£åœ¨æ–½å±•é­”æ³•</h2>
            <p className="text-slate-500 mt-2 text-sm flex items-center gap-2">
               <Loader2 size={14} className="animate-spin" />
               {loadingStatus}
            </p>
            {visualStyle && (
              <div className="mt-4 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-medium">
                æ­£åœ¨ä½¿ç”¨ Gemini Image æ¨¡å‹é€²è¡Œé¢¨æ ¼è½‰æ›...
              </div>
            )}
            <div className="mt-2 text-xs text-slate-400">
               {refMedia || refText ? `æ­£åœ¨å­¸ç¿’åƒè€ƒè³‡æ–™ä¸­çš„é¢¨æ ¼...` : ''}
            </div>
          </div>
        )}

        {step === 3 && generatedResult && (
          <div className="animate-in slide-in-from-bottom-8 duration-700 grid lg:grid-cols-12 gap-8 items-start">
            
            <div className="lg:col-span-12 flex items-center justify-between mb-2">
               <button onClick={() => setStep(1)} className="flex items-center gap-2 text-sm text-slate-500 hover:text-indigo-600 transition-colors">
                <ArrowRight className="rotate-180" size={16} /> è¿”å›ä¿®æ”¹
              </button>
               <div className="flex gap-2">
                 <button onClick={resetApp} className="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 text-sm">
                  <RefreshCcw size={14} /> é‡ä¾†
                </button>
                <button className="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm shadow-sm hover:shadow">
                  <Share2 size={14} /> ç™¼å¸ƒ
                </button>
              </div>
            </div>

            <div className="lg:col-span-5 space-y-4">
              <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                <div className="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                  <h3 className="font-semibold text-slate-700 flex items-center gap-2 text-sm">
                    <ImageIcon size={16} className="text-indigo-500" />
                    å°é¢è¨­è¨ˆé è¦½
                  </h3>
                  <div className="flex items-center gap-2">
                    {aiCoverImage && (
                      <span className="text-[10px] bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-2 py-0.5 rounded-full flex items-center gap-1">
                        <Wand2 size={8} /> AI ç”Ÿæˆåº•åœ–
                      </span>
                    )}
                    <div className="text-[10px] text-slate-400 uppercase tracking-wider font-medium">
                      {ratios.find(r => r.id === coverRatio)?.name}
                    </div>
                  </div>
                </div>

                <div className="p-3 border-b border-slate-100 grid grid-cols-1 gap-4">
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                      <Maximize size={12} /> åœ–ç‰‡æ¯”ä¾‹
                    </label>
                    <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                      {ratios.map(r => (
                        <button
                          key={r.id}
                          onClick={() => setCoverRatio(r.class)}
                          className={`px-3 py-1.5 text-xs whitespace-nowrap rounded-md border transition-colors ${
                            coverRatio === r.class 
                              ? 'bg-slate-800 text-white border-slate-800' 
                              : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'
                          }`}
                        >
                          {r.name.split(' ')[0]}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1">
                      <Layout size={12} /> æ’ç‰ˆé¢¨æ ¼
                    </label>
                    <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                      {Object.entries(coverStyles).map(([key, style]) => (
                        <button
                          key={key}
                          onClick={() => setCoverStyle(key)}
                          className={`px-3 py-1.5 text-xs whitespace-nowrap rounded-md border transition-colors ${
                            coverStyle === key 
                              ? 'bg-indigo-600 text-white border-indigo-600' 
                              : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'
                          }`}
                        >
                          {style.name}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="p-6 bg-slate-100 flex items-center justify-center overflow-hidden">
                  <div className={`relative w-full ${coverRatio} shadow-xl group transition-all duration-300`}>
                    
                    <img 
                      src={aiCoverImage || mediaPreview} 
                      alt="Cover" 
                      className="absolute inset-0 w-full h-full object-cover transition-all duration-500"
                      style={!aiCoverImage ? { filter: coverStyle === 'cinematic' ? 'contrast(1.1) saturation(0.8)' : 'brightness(0.9)' } : {}}
                    />

                    <div className={`absolute inset-0 transition-all duration-300 ${currentStyle.overlayClass}`}></div>
                    
                    {currentStyle.deco(platform)}

                    <div className={`absolute transition-all duration-300 ${currentStyle.textContainerClass}`}>
                      <h2 className={currentStyle.titleClass}>
                        {generatedResult.coverTitle || keywords}
                      </h2>
                      <div className={currentStyle.subtitleClass}>
                        {generatedResult.coverSubtitle || 'AI Generated Title'}
                      </div>
                    </div>

                    <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-20">
                      <button className="bg-white text-slate-900 px-4 py-2 rounded-full font-medium text-sm flex items-center gap-2 transform translate-y-2 group-hover:translate-y-0 transition-transform">
                        <Download size={16} /> ä¸‹è¼‰å°é¢
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div className="lg:col-span-7 space-y-4">
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col min-h-[600px]">
                <div className="p-4 border-b border-slate-100 flex items-center justify-between">
                  <div className="flex items-center gap-2">
                     <div className={`p-1.5 rounded-lg ${platforms.find(p => p.id === platform)?.color}`}>
                       {platforms.find(p => p.id === platform)?.icon}
                     </div>
                     <span className="font-semibold text-slate-700 text-sm">
                       {platforms.find(p => p.id === platform)?.name} æ–‡æ¡ˆ
                     </span>
                  </div>
                  <button 
                    onClick={handleCopy}
                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                      isCopied 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                    }`}
                  >
                    {isCopied ? <Check size={14} /> : <Copy size={14} />}
                    {isCopied ? 'å·²è¤‡è£½' : 'è¤‡è£½å…§å®¹'}
                  </button>
                </div>

                <div className="relative flex-1">
                  <textarea
                    className="w-full h-full p-6 resize-none outline-none text-slate-700 leading-relaxed text-base font-sans bg-transparent"
                    value={platform === 'blog' 
                      ? generatedResult.caption 
                      : generatedResult.caption + '\n\n' + (generatedResult.hashtags || '')
                    }
                    onChange={(e) => {
                      setGeneratedResult({...generatedResult, caption: e.target.value})
                    }}
                  />
                </div>
                
                <div className="p-3 bg-slate-50 border-t border-slate-100 rounded-b-2xl">
                  <div className="flex items-center gap-2 text-xs text-slate-500">
                    <Sparkles size={14} className="text-indigo-400" />
                    <span>
                      {aiCoverImage ? 'å·²é‡ç¹ªåº•åœ–ï¼Œ' : ''}æ–‡æ¡ˆå·²ä¾æ“šã€Œ{personas.find(p => p.id === persona)?.name}ã€äººè¨­åŠåƒè€ƒè³‡æ–™å„ªåŒ–ã€‚
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
